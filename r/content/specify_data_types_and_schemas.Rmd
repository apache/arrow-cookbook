# Defining Data Types

As discussed in previous chapters, Arrow automatically infers the most appropriate data type when reading in data or converting R objects to Arrow objects.  However, you might want to manually tell Arrow which data types to use, for example, to ensure interoperability with databases and data warehouse systems.  In this chapter, we will discuss 2 different ways of changing Arrow object type:

1. Changing the type of existing Arrow objects
2. Defining data types during the process of creating Arrow objects

## Update the data type of an existing Arrow Array

You want to change the type of an existing Arrow Array.

### Solution

```{r, cast_array}
# Create an Array to cast
integer_arr <- Array$create(1:5)

# Cast to an unsigned int8 type
uint_arr <- integer_arr$cast(target_type = uint8())

uint_arr
```

```{r, test_cast_array, opts.label = "test"}
test_that("cast_array works as expected", {
  expect_equal(
   uint_arr$type,
   uint8()
  )
})
```

## Update the data type of an existing Arrow Table

You want to change the type of a field in an existing Arrow Table.

### Solution

```{r, cast_table}
# Set up a tibble to use in this example
oscars <- tibble::tibble(
  actor = c("Katharine Hepburn", "Meryl Streep", "Jack Nicholson"),
  num_awards = c(4, 3, 3)
)

# Convert tibble to an Arrow table
oscars_arrow <- Table$create(oscars)

# The default mapping from numeric column "num_awards" is to a double
oscars_arrow

# Set up schema with "num_awards" as integer
oscars_schema <- schema(actor = string(), num_awards = int16())

# Cast to an int16
oscars_arrow_int <- oscars_arrow$cast(target_schema = oscars_schema)

oscars_arrow_int
```

```{r, test_cast_table, opts.label = "test"}
test_that("cast_table works as expected", {
  expect_equal(
    oscars_arrow_int$schema,
    schema(actor = string(), num_awards = int16())
  )
})
```

## Specify data types when creating an Arrow table from an R object

You want to manually specify Arrow data types when converting an object from a data frame to an Arrow object.

### Solution

```{r, use_schema}
# Set up a tibble to use in this example
oscars <- tibble::tibble(
  actor = c("Katharine Hepburn", "Meryl Streep", "Jack Nicholson"),
  num_awards = c(4, 3, 3)
)

# Set up schema with "num_awards" as integer
oscars_schema <- schema(actor = string(), num_awards = int16())

# create arrow Table containing data and schema
oscars_data_arrow <- Table$create(oscars, schema = oscars_schema)

oscars_data_arrow
```
```{r, test_use_schema, opts.label = "test"}
test_that("use_schema works as expected", {
  expect_s3_class(oscars_data_arrow, "Table")
  expect_equal(
    oscars_data_arrow$schema,
    oscars_schema
  )
})
```

## Specify data types when reading in files

You want to manually specify Arrow data types when reading in files.

### Solution

```{r, use_schema_dataset}
# Set up a tibble to use in this example
oscars <- tibble::tibble(
  actor = c("Katharine Hepburn", "Meryl Streep", "Jack Nicholson"),
  num_awards = c(4, 3, 3)
)

# write dataset to disk
write_dataset(oscars, path = "oscars_data")

# Set up schema with "num_awards" as integer
oscars_schema <- schema(actor = string(), num_awards = int16())

# read the dataset in, using the schema instead of inferring the type automatically
oscars_dataset_arrow <- open_dataset("oscars_data", schema = oscars_schema)

oscars_dataset_arrow
```
```{r, test_use_schema_dataset, opts.label = "test"}
test_that("use_schema_dataset works as expected", {
  expect_s3_class(oscars_dataset_arrow, "Dataset")
  expect_equal(oscars_dataset_arrow$schema,
    oscars_schema
  )
})
```
```{r, include=FALSE}
unlink("oscars_data", recursive = TRUE)
```

### Discussion

There are some Arrow data types which do not have compatible R equivalents.  
Attempting to cast to these data types will results in an error.

```{r, float_16_conversion, error=TRUE}
oscars <- tibble::tibble(
  actor = c("Katharine Hepburn", "Meryl Streep", "Jack Nicholson"),
  num_awards = c(4, 3, 3)
)

# Set up schema with "num_awards" as float16 which doesn't have an R equivalent
oscars_schema <- schema(actor = string(), num_awards = float16())

Table$create(oscars, schema = oscars_schema)

```

```{r, test_float_16_conversion, opts.label = "test"}
test_that("float_16_conversion works as expected", {
  expect_error(Table$create(oscars, schema = oscars_schema))
})
```

### See also

A table showing the default mapping between R and Arrow data types can be found 
in [R data type to Arrow data type mappings](#r2arrow).

A table containing compatible R/Arrow data types can be found in 
[Arrow data type to R data type mapping](#arrow2r).

## Combine and harmonize schemas

You have a dataset split across multiple sources for which you have separate 
schemas that you want to combine.

### Solution

You can use `unify_schemas()` to combine multiple schemas into a single schemas.

```{r, combine_schemas}
# create first schema to combine
country_code_schema <- schema(country = utf8(), code = utf8())

# create second schema to combine
country_phone_schema <- schema(country = utf8(), phone_prefix = int8())

# combine schemas
combined_schemas <- unify_schemas(country_code_schema, country_phone_schema)
combined_schemas
```

```{r, test_combine_schemas, opts.label = "test"}
test_that("combine_schemas works as expected", {
  expect_s3_class(combined_schemas, "Schema")
  expect_equal(combined_schemas,
    schema(country = utf8(), code = utf8(), phone_prefix = int8())
  )
})
```
### Discussion

on:
  push:
     branches:
       - main

name: Deploy Cookbooks

jobs:
  make_cookbooks:
    name: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Setup R
        uses: r-lib/actions/setup-r@v1
      - name: Setup pandoc
        uses: r-lib/actions/setup-pandoc@v1
      - name: Install dependencies
        run: sudo apt install libcurl4-openssl-dev libssl-dev python3-pip
      - name: Run tests
        run: make test
      - name: Build and render books
        run: make all
      - name: Upload book artifact
        uses: actions/upload-artifact@v1
        with:
          name: build_book
          path: build/

  deploy_cookbooks:
    name: deploy
    runs-on: ubuntu-latest
    needs: make_books
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v2
        with:
          ref: gh-pages
      - name: Download book artifact
        uses: actions/download-artifact@v1.0.0
        with:
          name: build_book
          path: .
      - name: Push changes to gh-pages branch
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add *
          git commit -m 'publish built book'
          git push origin gh-pages
